<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Reddit Browser</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link rel="stylesheet" href="css/bootstrap.css">
    <!--<link rel="stylesheet/less" href="css/bootstrap.less"> -->
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.1.3/less-1.1.3.min.js"></script> -->
    <style type="text/css">
      .form-inline {
        margin-top: 0;
        margin-bottom: 5px;
      }
      .form-inline .btn {
        margin-top: 0;
      }
      .form-inline .btn-group {
        display: inline-block;
        margin-bottom: 0;
        margin-top: 0;
        top: 10px;
      }

      .brand {
        margin-top: 5px;
      }
      #main {
        margin-top: 50px;
        padding-left: 0; padding-right: 0;
      }

      .fluid-content {
        /*margin-left: 230px;*/
        overflow: auto;
      }

      .fluid-content-without-comments {
        /*margin-right: 230px;*/
      }

      #stories-holder, #comments-holder {
        overflow-y: scroll;
        width: 230px;
      }

      #stories small {
        color: #BFBFBF;
      }

      #stories tr:hover {
        background-color: #EFF;
      }

      #stories tr:nth-child(odd):hover td {
        background-color: #EFF;
      }

      #stories tr a.superlink {
        text-decoration: none;
        display: block;
        margin: -8;
        padding: 8;
      }

      #stories tr.active, #stories tr.active:nth-child(odd) td {
        background-color: #E0E0E0;
      }

      .comment > .replies {
        padding-left: 10px;
      }

      .comment > .replies > .replies{
        padding-left: 10px;
      }

      .comment > .replies > .replies > .replies {
        padding-left: 10px;
      }

      .comment > .replies > .replies > .replies > .replies{
        padding-left: 10px;
      }

      .message {
        padding-left: 15px;
        margin-bottom: 18px;
        border-left: 5px solid #EEE;
      }

      a.superlink small {
        white-space: nowrap;
        overflow: hidden;
      }

      a.superlink {
        font-weight: bold;
      }

      a.superlink.read {
        font-weight: normal;
      }

      div.message span.cite{
        float: right;
        color: #BFBFBF;
      }

      div.message span.cite:before {
        content: ' - ';
      }

      .extLink {
        visibility: hidden;
      }

      tr.storyRow:hover .extLink {
        visibility: visible;
      }
    </style>

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="http://www.redditstatic.com/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="http://timeago.yarp.com/jquery.timeago.js"></script>
    <script src="https://raw.github.com/coreyti/showdown/master/compressed/showdown.js"></script>
    <script>
      jQuery.timeago.settings.strings = {
        prefixAgo: null,
        prefixFromNow: null,
        suffixAgo: "ago",
        suffixFromNow: "from now",
        seconds: "seconds",
        minute: "seconds",
        minutes: "%d minutes",
        hour: "about an hour",
        hours: "about %d hours",
        day: "a day",
        days: "%d days",
        month: "about a month",
        months: "%d months",
        year: "about a year",
        years: "%d years",
        wordSeparator: " ",
        numbers: []
      };
    </script>
    <script src="https://github.com/andyet/ICanHaz.js/raw/master/ICanHaz.min.js"></script>
    <script src="js/bootstrap.js"></script>

    <!-- ICH Templates -->
    <script id="story" type="text/html">
      <tr class="storyRow">
        <td>
          <a href="#{{id}}" comments="http://www.reddit.com/{{permalink}}" story="{{url}}" isSelf="{{is_self}}" 
                class="superlink" id="{{id}}"
                oembed="{{media.oembed.html}}"
              >
            <span>
              <small>{{author}}</small>
            </span>
            <span>
              <small class="pull-right">{{domain}}</small>
            </span>
            <div>{{title}}</div>
          </a>
          <a href="{{url}}" target="_blank" class="extLink">Story</a>
          <a href="http://www.reddit.com/{{permalink}}" target="_blank" class="extLink">Thread</a>
          <small class="pull-right extLink">
            <abbr class="timeago" title="{{created_timestamp}}">{{created_timestamp}}</abbr>
          </small>
        </td>
      </tr>
    </script>    

    <script id="comment" type="text/html">
      <div id="{{id}}" class="comment">
        <div class="message">{{{body}}}
        <span class="cite">{{author}}</span>
        </div>
        <div class="replies"></div>
      </div>
    </script>    

  </head>

  <body>

    <div class="navbar navbar-fixed-top" data-scrollspy="scrollspy">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="./index.html">Reddit Browser</a>
          <form class="form-inline form-horizontal" id="redditSelector">
            <input id="reddit-name"></input>
            <input id="browse" class="btn primary" type="button" value="Browse"></input>
            <div class="btn-group" data-toggle="buttons-radio">
              <button class="btn" id="popular">Popular</button>
              <button class="btn" id="newstories">New</button>
            </div>            
          </form>
        </div>
      </div>
    </div>

    <div class="container-fluid" id="main">
      <div class="row">
        <div class="fluid-sidebar-left span2" id="stories-holder">
          <table id="stories" class="table table-striped">
          </table>
        </div>
        <div class="fluid-sidebar-right span2 pull-right" id="comments-holder">
          Comments
        </div>
        <div class="fluid-content span8">
          <div id="story-holder">
            Story
          </div>
        </div>
      </div>
    </div>

    <script>
      var storyCount = 0;
      var lastMarker = null;
      var fetchingStories = false;
      var newReddits = false;

      $('#popular').click(function() {
        newReddits = false;
      });

      $('#newstories').click(function() {
        newReddits = true;
      });

      $('#popular').button('toggle');

      function addReplies(id, replies) {
        if (replies && replies.data && replies.data.children) {
          $.each(replies.data.children, function(replyId) {
            var reply = replies.data.children[replyId];
            reply.data.body = formatCommentWell(reply.data.body);
            if (document.getElementById(reply.data.id) == null) {
              $('#' + id+' > .replies').append(ich.comment(reply.data));
              if (reply.data.replies) {
                addReplies(reply.data.id, reply.data.replies);
              }
            }
          });
        }
      }

      function processStories(response) {
        storyCount += 25;
        lastMarker = response.data.after;
        var currScroll = $('#stories-holder').scrollTop();
        
        $.each(response.data.children, function(ctr) {
          var child = response.data.children[ctr];
          if (document.getElementById(child.data.id) == null) {
            child.data.created_timestamp = $.timeago(getLocalTime(child.data.created_utc));
            var storyText = ich.story(child.data);
            $('#stories').append(storyText);
          }
        });


        $('a.superlink').click(function(event) {
          $(event.currentTarget).addClass('read');

          if (event.currentTarget.attributes.oembed.value == '') {
            var storyUrl = event.currentTarget.attributes.story.value;

            if (storyUrl.match(/jpg$/) || storyUrl.match(/png$/) || storyUrl.match(/gif$/) ) {
              $('#story-holder').html('<img src="' + storyUrl + '" height="' + $('#stories-holder').height() + 'px" id="theImage"></img>');
              $('#theImage').css('max-height', $('#stories-holder').height() - 30);
              $('#theImage').css('max-width', $('.fluid-content').width());
              setTimeout(100, function() {
                $('#theImage').css('width', '100%');
              });
            } else {
              $('#story-holder').html('<iframe width="100%" height="100%" name="youriframe" frameborder="0" vspace="0" hspace="0" arginwidth="0" marginheight="0" scrolling="yes" noresize src="' + storyUrl + '"></iframe>');
            }

          } else {

            $('#story-holder').html(event.currentTarget.attributes.oembed.value);

          }
          $('#stories tr').removeClass('active');
          $(event.currentTarget).parents('tr').addClass('active');
          if (event.currentTarget.attributes.isSelf.value == 'false') {
            $('#comments-holder').html('');
            $.ajax({
              dataType: 'jsonp',
              jsonp: 'jsonp',
              success : function(response) {
                var commentsSection = response[1];
                $.each(commentsSection.data.children, function(commentId) {
                  var comment = commentsSection.data.children[commentId];
                  comment.data.body = formatCommentWell(comment.data.body);
                  if (!document.getElementById(comment.data.id)) {
                    $('#comments-holder').append(ich.comment(comment.data));
                    addReplies(comment.data.id, comment.data.replies);
                  }
                });
                $('.comment a').attr('target', '_blank');
              },
              url: event.currentTarget.attributes.comments.value + '.json',
              type: "GET"
            });
            $('#comments-holder').show();
            $('.fluid-content').width($('#main').width() - $('#stories-holder').width() * 2 - 60);
          } else {
            $('#comments-holder').html('&nbsp;');
            $('#comments-holder').hide();
            $('.fluid-content').width($('#main').width() - $('#stories-holder').width() - 30);
          }
          doSomething();

          return false;
        });

        $('#stories-holder').scrollTop(currScroll);
        fetchingStories = false;
      }
                    
      $('#browse').click(function() {
        $('#stories').html('');
        var redditName = $('#reddit-name').val();
        fetchingStories = true;
        $.ajax({
          dataType: 'jsonp',
          jsonp: 'jsonp',
          success : processStories,
          url: createRedditUrl(redditName, null),
          type: "GET"
        });
      });

      $('#redditSelector').submit(function() {
        $('#browse').click();
        return false;
      });

      $('#browse').click();

      $(window).load(function () {
        doSomething();          
      });

      function doSomething() {
        var diff = 54
        $('#stories-holder').height($(window).height() - diff);
        $('#comments-holder').height($(window).height() - diff);
        $('iframe').height($(window).height() - diff);
      };

      var resizeTimer;
      $(window).resize(function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(doSomething, 100);
      });


      $('#stories-holder').scroll(function(event){
        var scrollLeft = event.currentTarget.scrollHeight - event.currentTarget.scrollTop;
        var height = event.currentTarget.offsetHeight
        if (scrollLeft < 2 * height) {
          fetchMoreStories();
        }
      });

      function getLocalTime(utc) {
        var d = new Date(0);
        d.setUTCSeconds(utc);
        return d;
      }

      function fetchMoreStories() {
        if (fetchingStories) {
          return;
        }
        fetchingStories = true;

        var scrollTop = $('#stories-holder').scrollTop();
        var scrollMax = $('#stories-holder')[0].scrollHeight;

        var redditName = $('#reddit-name').val();
        $.ajax({
          dataType: 'jsonp',
          jsonp: 'jsonp',
          success : processStories,
          url: createRedditUrl(redditName, lastMarker) ,
          type: "GET"
        });
      }

      function formatComment(text, regexp, rewrite) {
        var oldText = text;
        if (text != null) {
          text = text.replace(regexp, rewrite);
        }
        return text;
      }

      var converter = new Showdown.converter();

      function formatCommentWell(text) {

        if (text == null) {
          return null;
        }

        text = htmlDecode(text);

        text = formatComment(text, /(^|[^\(])(https?[\.\w:/\?\+\-\=\&\%]*)([^\)]|$)/g, ' [$2]($2) ');
        var text = converter.makeHtml(text);
        text = formatComment(text, /~~([^~]*)~~/g, '<del>$1</del>');

        return text;
      }

      function createRedditUrl(redditName, lastMarker) {
        if (newReddits) {
          if (lastMarker == null) {
            return 'http://www.reddit.com/' + redditName + '/new.json?sort=new';
          } else {
            return 'http://www.reddit.com/' + redditName + '/new.json?sort=new&after=' + lastMarker;
          }
        } else {
          if (lastMarker == null) {
            return 'http://www.reddit.com/' + redditName + '/.json';
          } else {
            return 'http://www.reddit.com/' + redditName + '/.json?after=' + lastMarker;
          }
        }
      }

      function htmlDecode(input){
        var e = document.createElement('div');
        e.innerHTML = input;
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
      }      
    </script>
  </body>
</html>